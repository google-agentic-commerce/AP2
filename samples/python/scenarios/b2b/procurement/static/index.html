<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>B2B Procurement Agent Demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    .card { border:1px solid #ddd; padding:12px; border-radius:8px; margin:12px 0; }
    button { padding:8px 12px; margin-top:8px; }
    pre { background:#f7f7f7; padding:10px; border-radius:6px; overflow:auto; }
    .notice { color:#b00; font-size:0.9em; }
  </style>
</head>
<body>
  <h1>B2B Procurement Agent (AP2)</h1>
  <div class="card">
    <label>User: <input id="user" value="alice"/></label>
    <br/><br/>
    <input id="query" style="width:70%" placeholder="E.g. Request a laptop under $1200"/>
    <button id="intentBtn">Create Intent</button>
  </div>

  <div id="candidates"></div>
  <h3>Mandates Log</h3>
  <div id="log"></div>

<script>
const logEl = document.getElementById('log');
function log(obj){
  const pre = document.createElement('pre');
  pre.textContent = JSON.stringify(obj, null, 2);
  logEl.prepend(pre);
}

document.getElementById('intentBtn').onclick = async () => {
  const user = document.getElementById('user').value;
  const query = document.getElementById('query').value;
  if (!query) return alert('Enter a request');
  const resp = await fetch('/intent', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({user, query})
  });
  const j = await resp.json();
  log(j.mandate);
  showCandidates(j.candidates, j.intent_id);
};

function showCandidates(candidates, intent_id){
  const container = document.getElementById('candidates');
  container.innerHTML = '';
  candidates.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'card';

    const title = document.createElement('b');
    title.textContent = `${it.title} ($${it.price})`;
    const vendor = document.createElement('div');
    vendor.textContent = `Vendor: ${it.vendor}`;

    const btn = document.createElement('button');
    btn.textContent = "Select & Create Cart";
    btn.onclick = async ()=>{
      const resp = await fetch('/cart', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({intent_id, item_id: it.id})
      });
      const j = await resp.json();
      log(j.mandate);
      showCartForApproval(j.cart_id, j.mandate);
    };

    el.appendChild(title);
    el.appendChild(document.createElement('br'));
    el.appendChild(vendor);
    el.appendChild(document.createElement('br'));
    el.appendChild(btn);
    container.appendChild(el);
  });
}

function showCartForApproval(cart_id, cart_mandate){
  const container = document.getElementById('candidates');
  const el = document.createElement('div');
  el.className = 'card';

  const details = cart_mandate.contents.payment_request.details;
  const item = details.display_items[0];

  const header = document.createElement('h3');
  header.textContent = "Cart Proposal";

  const itemInfo = document.createElement('div');
  itemInfo.textContent = `${item.label} - $${item.amount.value}`;

  const vendor = document.createElement('div');
  vendor.textContent = `Vendor: ${cart_mandate.contents.merchant_name}`;

  const paymentArea = document.createElement('div');
  paymentArea.id = `payment-area-${cart_id}`;
  paymentArea.innerHTML = `
    <h4>Payment (demo)</h4>
    <div class="notice">Demo only â€” do not use real card data</div>
    <label>Card number: <input id="cardnum-${cart_id}" placeholder="4242 4242 4242 4242"/></label><br/>
    <label>Card holder: <input id="cardname-${cart_id}" placeholder="Alice"/></label><br/>
    <label>Expiry (MM/YY): <input id="expiry-${cart_id}" placeholder="01/30"/></label>
    <label>CVV: <input id="cvv-${cart_id}" placeholder="123" style="width:80px"/></label><br/>
    <button id="pay-btn-${cart_id}">Pay (send OTP)</button>
  `;

  const otpArea = document.createElement('div');
  otpArea.id = `otp-area-${cart_id}`;
  otpArea.style.display = 'none';
  otpArea.innerHTML = `
    <label>Enter OTP (demo OTP is 123): <input id="otp-${cart_id}" /></label>
    <button id="confirm-otp-${cart_id}">Confirm OTP</button>
  `;

  const result = document.createElement('div');
  result.id = `result-${cart_id}`;

  el.appendChild(header);
  el.appendChild(itemInfo);
  el.appendChild(vendor);
  el.appendChild(paymentArea);
  el.appendChild(otpArea);
  el.appendChild(result);

  container.prepend(el);

  document.getElementById(`pay-btn-${cart_id}`).onclick = async () => {
    const payload = {
      cart_id,
      method: "card",
      card_number: document.getElementById(`cardnum-${cart_id}`).value,
      card_holder: document.getElementById(`cardname-${cart_id}`).value,
      expiry: document.getElementById(`expiry-${cart_id}`).value,
      cvv: document.getElementById(`cvv-${cart_id}`).value
    };
    const resp = await fetch('/payment', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await resp.json();
    document.getElementById(`payment-area-${cart_id}`).style.display = 'none';
    document.getElementById(`otp-area-${cart_id}`).style.display = 'block';
    el.dataset.otpToken = j.otp_token;
    result.textContent = j.notice || "OTP sent (demo)";
  };

  document.getElementById(`confirm-otp-${cart_id}`).onclick = async () => {
    const otpToken = el.dataset.otpToken;
    const otpVal = document.getElementById(`otp-${cart_id}`).value;
    const resp = await fetch('/payment/confirm', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({otp_token: otpToken, otp: otpVal})
    });
    const j = await resp.json();
    log(j.payment);
    result.textContent = `${j.status} | Transaction: ${j.transaction.transaction_id}`;
    document.getElementById(`otp-area-${cart_id}`).style.display = 'none';
  };
}
</script>
</body>
</html>
